#!/usr/bin/env node
import{createRequire as oe}from"module";import T from"path";import h from"fs-extra";import ie from"yaml";import se from"yargs";function k(e){let t=String(e).trim();if(typeof e=="number")return{isValid:!0,value:{kind:"NumberValue",value:e}};let r=E(t);if(r.isValid)return r;let n=P(t);if(n.isValid)return n;let o=N(t);if(o.isValid)return o;let i=x(t);if(i.isValid)return i;let a=W(t);if(a.isValid)return a;let s=O(t);if(s.isValid)return s;let l=Y(t);return l.isValid?l:{isValid:!0,value:{kind:"StringValue",value:t}}}function f(e){switch(e.kind){case"HexColor":return e.value;case"RgbColor":return`rgb(${e.r}, ${e.g}, ${e.b})`;case"RgbaColor":return`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`;case"TokenRef":return`$${e.collection}.${e.token}`;case"SizeValue":return`${e.value}${e.unit}`;case"DurationValue":return`${e.value}${e.unit}`;case"NumberValue":return e.value.toString();case"StringValue":return e.value;case"ShadowLayer":let t=f(e.offsetX),r=f(e.offsetY),n=f(e.blur),o=f(e.spread),i=f(e.color);return`${t} ${r} ${n} ${o} ${i}`;case"Shadow":return e.layers.map(a=>f(a)).join(", ");default:return String(e)}}function E(e){return/^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{4}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$/.test(e)?{isValid:!0,value:{kind:"HexColor",value:e}}:{isValid:!1,error:`Invalid hex color: ${e}`}}function P(e){let t=/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/,r=e.match(t);if(!r)return{isValid:!1,error:`Invalid rgb color: ${e}`};let[,n,o,i]=r,a=parseInt(n,10),s=parseInt(o,10),l=parseInt(i,10);return a<0||a>255||s<0||s>255||l<0||l>255?{isValid:!1,error:`Invalid RGB values: ${e}`}:{isValid:!0,value:{kind:"RgbColor",r:a,g:s,b:l}}}function N(e){let t=/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*([01]?\.?\d*)\s*\)$/,r=e.match(t);if(!r)return{isValid:!1,error:`Invalid rgba color: ${e}`};let[,n,o,i,a]=r,s=parseInt(n,10),l=parseInt(o,10),c=parseInt(i,10),u=parseFloat(a);return s<0||s>255||l<0||l>255||c<0||c>255?{isValid:!1,error:`Invalid RGB values: ${e}`}:u<0||u>1?{isValid:!1,error:`Invalid alpha value: ${e}`}:{isValid:!0,value:{kind:"RgbaColor",r:s,g:l,b:c,a:u}}}function x(e){if(!/^\$[a-zA-Z0-9][a-zA-Z0-9_-]*(?:\.[a-zA-Z0-9][a-zA-Z0-9_-]*)+$/.test(e))return{isValid:!1,error:`Invalid token reference: ${e}`};let n=e.substring(1).split(".");if(n.length<2)return{isValid:!1,error:`Invalid token format: ${e}`};let o=n[n.length-1];return{isValid:!0,value:{kind:"TokenRef",collection:n.slice(0,-1).join("."),token:o}}}function O(e){let t=/^([+-]?\d*\.?\d+)(px|rem|em|vw|vh|%)$/,r=e.match(t);if(!r)return{isValid:!1,error:`Invalid size: ${e}`};let[,n,o]=r,i=parseFloat(n);return isNaN(i)?{isValid:!1,error:`Invalid size value: ${e}`}:{isValid:!0,value:{kind:"SizeValue",value:i,unit:o}}}function Y(e){let t=/^([+-]?\d*\.?\d+)(ms|s)$/,r=e.match(t);if(!r)return{isValid:!1,error:`Invalid duration: ${e}`};let[,n,o]=r,i=parseFloat(n);return isNaN(i)?{isValid:!1,error:`Invalid duration value: ${e}`}:{isValid:!0,value:{kind:"DurationValue",value:i,unit:o}}}function G(e){if(!e)return{isValid:!1,error:"Missing color value"};if(e.startsWith("$"))return x(e);if(e.startsWith("var("))return{isValid:!0,value:{kind:"StringValue",value:e}};let t=E(e);if(t.isValid)return t;let r=P(e);if(r.isValid)return r;let n=N(e);return n.isValid?n:{isValid:!1,error:`Invalid color: ${e}`}}function W(e){if(!e.includes("px")&&!e.includes("$"))return{isValid:!1,error:`Invalid shadow format: ${e}`};try{let t=e.split(",").map(n=>n.trim()),r=[];for(let n of t){let o=H(n);if(!o.isValid||!o.value)return{isValid:!1,error:`Invalid shadow layer: ${n}`};r.push(o.value)}return{isValid:!0,value:{kind:"Shadow",layers:r}}}catch{return{isValid:!1,error:`Invalid shadow format: ${e}`}}}function H(e){let t=e.trim().split(/\s+/);if(t.length<4)return{isValid:!1,error:`Invalid shadow layer format: ${e}`};try{let r=y(t[0]),n=y(t[1]),o=y(t[2]),i=y(t[3]);if(!r.isValid||!n.isValid||!o.isValid||!i.isValid)return{isValid:!1,error:`Invalid shadow dimensions: ${e}`};let a=t.slice(4).join(" ").trim(),s=G(a);return s.isValid?{isValid:!0,value:{kind:"ShadowLayer",color:s.value,offsetX:r.value,offsetY:n.value,blur:o.value,spread:i.value}}:{isValid:!1,error:`Invalid shadow color: ${a}`}}catch{return{isValid:!1,error:`Invalid shadow layer: ${e}`}}}function y(e){return e.startsWith("$")?x(e):O(e)}function v(e,t){return{tokens:B(e),collections:X(t)}}function X(e){return e.data.map(t=>({name:t.name,modes:t.modes}))}function Z(e){let{collection:t,tokens:r}=e.data;return Object.entries(r).map(([n,o])=>{let i=Object.entries(o.values).map(([a,s])=>({mode:a,value:s}));return{token:{name:n,collection:t},values:i}})}function B(e){return e.flatMap(Z)}function U(e){return k(e)}function q(e){let t=[];return e.forEach(r=>{r.values.forEach(n=>{let o=U(n.value);t.push({tokenName:r.token.name,collection:r.token.collection,mode:n.mode,value:n.value,result:o})})}),t}function g(e){let t=[];return e.kind==="TokenRef"?t.push({collection:e.collection,token:e.token}):e.kind==="ShadowLayer"?(t.push(...g(e.color)),t.push(...g(e.offsetX)),t.push(...g(e.offsetY)),t.push(...g(e.blur)),t.push(...g(e.spread))):e.kind==="Shadow"&&e.layers.forEach(r=>{t.push(...g(r))}),t}function K(e,t){let r=[],n=[],o=e.data.collection,i=t.get(o);return i?(Object.entries(e.data.tokens).forEach(([a,s])=>{let l=Object.keys(s.values),c=i.modes.filter(u=>!l.includes(u));c.length>0&&r.push({type:"MISSING_MODE",message:`Token '${a}' is missing modes: ${c.join(", ")}`,tokenName:a,collection:o}),Object.entries(s.values).forEach(([u,d])=>{let p=k(d);p.isValid||r.push({type:"INVALID_VALUE_FORMAT",message:p.error||`Invalid value format for token '${a}' in mode '${u}'`,tokenName:a,collection:o,mode:u,value:d})})}),{isValid:r.length===0,errors:r,warnings:n}):(r.push({type:"INVALID_COLLECTION",message:`Collection '${o}' is not defined`,collection:o}),{isValid:!1,errors:r,warnings:n})}function J(e,t){let r=[],n=[];return q(e).forEach(({tokenName:i,collection:a,mode:s,value:l,result:c})=>{if(!c.isValid){r.push({type:"INVALID_VALUE_FORMAT",message:c.error||"Invalid value format",tokenName:i,collection:a,mode:s,value:l});return}c.value&&g(c.value).forEach(({collection:d,token:p})=>{let D=`$${d}.${p}`;t.find(_=>_.token.name===D)||r.push({type:"INVALID_PRIMITIVE_TOKEN",message:`Referenced token '${D}' not found`,tokenName:i,collection:a,mode:s,value:l})})}),{isValid:r.length===0,errors:r,warnings:n}}function z(e,t){let r=[],n=[];e.forEach(s=>{let l=K(s,t);r.push(...l.errors),n.push(...l.warnings)});let o={kind:"TokenCollections",metadata:{id:"temp",name:"temp"},data:Array.from(t.values())},i=v(e,o),a=J(i.tokens,i.tokens);return r.push(...a.errors),n.push(...a.warnings),{isValid:r.length===0,errors:r,warnings:n}}function b(e,t){let r=new Map(t.data.map(o=>[o.name,o])),n=z(e,r);if(!n.isValid)throw console.error("Token validation failed:"),n.errors.forEach(o=>{console.error(`  ${o.message}`)}),new Error("Token validation failed. Please fix the errors above.");return n.warnings.length>0&&(console.warn("Token validation warnings:"),n.warnings.forEach(o=>{console.warn(`  ${o}`)})),v(e,t)}function R(e,t,r){return{resolve(n){return m(n,e,t,r)},resolveTokenRef(n){let o=`$${n.collection}.${n.token}`;if(!e.find(s=>s.token.name===o))throw new Error(`Token not found: ${o}`);return`var(${r(o)})`}}}function m(e,t,r,n){switch(e.kind){case"TokenRef":let o=`$${e.collection}.${e.token}`;if(!t.find(s=>s.token.name===o))throw new Error(`Token not found: ${o}`);return{kind:"StringValue",value:`var(${n(o)})`};case"ShadowLayer":return{kind:"ShadowLayer",color:m(e.color,t,r,n),offsetX:m(e.offsetX,t,r,n),offsetY:m(e.offsetY,t,r,n),blur:m(e.blur,t,r,n),spread:m(e.spread,t,r,n)};case"Shadow":return{kind:"Shadow",layers:e.layers.map(s=>m(s,t,r,n))};default:return e}}function V(e){return typeof e=="string"?e:typeof e=="number"?e.toString():f(e)}function w(e,t,r,n){let o=String(e);if(!o.startsWith("$")){let s=k(o);if(s.isValid&&s.value){let c=R(t,"default",u=>r(u,n)).resolve(s.value);return V(c)}return e}let i=k(o);if(!i.isValid||!i.value)throw new Error(`Invalid token reference: ${o}`);return R(t,"default",s=>r(s,n)).resolveTokenRef(i.value)}function S(e,t){let r=e.replace(/^\$/,"").replace(/\./g,"-");return t?`--${t}-${r}`:`--${r}`}function Q(e,t,r,n){let o=e.values.find(s=>s.mode===t);if(!o)throw new Error(`No value found for token '${e.token.name}' in mode '${t}'`);let i=w(o.value,r,S,n);return`${S(e.token.name,n)}: ${V(i)};`}function ee(e,t,r,n,o){let i=t.map(a=>`  ${Q(a,r,n,o)}`).join(`
`);return`${e} {
${i}
}`}function F(e,t){let{prefix:r,banner:n="",selectors:o={}}=t,{tokens:i,collections:a}=e,s=a.flatMap(l=>{let c=i.filter(u=>u.token.collection===l.name);return l.modes.map(u=>{var p;let d=((p=o[l.name])==null?void 0:p[u])||":root";return ee(d,c,u,i,r)})}).join(`

`);return`${n}${s}`}function te(e,t,r={}){let n=b(e,t);return F(n,r)}var C={generateCssVariables:te,generateCssVarsFromAst:F,createCssVarName:S};function $(e,t){let r=e.replace(/^\$/,"");return r.startsWith("number.")?r=r.replace("number.","spacing-"):r.startsWith("letter-spacing.")?r=r.replace("letter-spacing.","tracking-"):r=r.replace(/\./g,"-"),t?`--${t}-${r}`:`--${r}`}function re(e,t,r){let{prefix:n}=r,o=[],i=new Set;return e.forEach(a=>{if(i.has(a.token.name))return;i.add(a.token.name);let s=a.values.find(d=>d.mode===t);if(!s)return;let l=w(s.value,e,$,n),c=V(l);a.token.name==="$number.1"&&o.push(`  --spacing: ${c};`);let u=$(a.token.name,n);o.push(`  ${u}: ${c};`)}),o.length>0?`@theme {
${o.join(`
`)}
}`:""}function ne(){return["@utility bg-* { background-color: --value(--color-*); }","@utility text-* { color: --value(--color-*); }","@utility border-* { border-color: --value(--color-*); }","@utility fill-* { fill: --value(--color-*); }","@utility stroke-* { stroke: --value(--color-*); }","@utility p-* { padding: --value(--spacing-*); }","@utility px-* { padding-left: --value(--spacing-*); padding-right: --value(--spacing-*); }","@utility py-* { padding-top: --value(--spacing-*); padding-bottom: --value(--spacing-*); }","@utility pt-* { padding-top: --value(--spacing-*); }","@utility pr-* { padding-right: --value(--spacing-*); }","@utility pb-* { padding-bottom: --value(--spacing-*); }","@utility pl-* { padding-left: --value(--spacing-*); }","@utility m-* { margin: --value(--spacing-*); }","@utility mx-* { margin-left: --value(--spacing-*); margin-right: --value(--spacing-*); }","@utility my-* { margin-top: --value(--spacing-*); margin-bottom: --value(--spacing-*); }","@utility mt-* { margin-top: --value(--spacing-*); }","@utility mr-* { margin-right: --value(--spacing-*); }","@utility mb-* { margin-bottom: --value(--spacing-*); }","@utility ml-* { margin-left: --value(--spacing-*); }","@utility w-* { width: --value(--spacing-*); }","@utility h-* { height: --value(--spacing-*); }","@utility min-w-* { min-width: --value(--spacing-*); }","@utility min-h-* { min-height: --value(--spacing-*); }","@utility max-w-* { max-width: --value(--spacing-*); }","@utility max-h-* { max-height: --value(--spacing-*); }","@utility gap-* { gap: --value(--spacing-*); }","@utility space-x-* { & > :not(:last-child) { --tw-space-x-reverse: 0; margin-inline-start: calc(--value(--spacing-*) * var(--tw-space-x-reverse)); margin-inline-end: calc(--value(--spacing-*) * calc(1 - var(--tw-space-x-reverse))); } }","@utility space-y-* { & > :not(:last-child) { --tw-space-y-reverse: 0; margin-block-start: calc(--value(--spacing-*) * var(--tw-space-y-reverse)); margin-block-end: calc(--value(--spacing-*) * calc(1 - var(--tw-space-y-reverse))); } }","@utility space-x-reverse { & > :not(:last-child) { --tw-space-x-reverse: 1; } }","@utility space-y-reverse { & > :not(:last-child) { --tw-space-y-reverse: 1; } }","@utility rounded-* { border-radius: --value(--spacing-*); }","@utility font-* { font-weight: --value(--font-weight-*); }","@utility tracking-* { letter-spacing: --value(--tracking-*); }","@utility shadow-* { box-shadow: --value(--shadow-*); }","@utility border-width-* { border-width: --value(--border-width-*); }"]}function A(e,t){let{banner:r=""}=t,{tokens:n,collections:o}=e,i=[];r&&i.push(r),i.push('@import "tailwindcss";'),i.push(""),o.forEach(s=>{let l=n.filter(c=>c.token.collection===s.name);s.modes.forEach(c=>{let u=re(l,c,t);u&&(i.push(u),i.push(""))})});let a=ne();return a.length>0&&(i.push(...a),i.push("")),i.join(`
`)}function L(e,t,r={}){let n=b(e,t);return A(n,r)}var I={build:L,buildFromAst:A,toVarName:$,generateTailwindCSS:L,generateTailwindFromAst:A,createTailwindVarName:$};var ae=oe(import.meta.url),le=ae.resolve("@cocso-ui/baseframe-sources"),ce=T.dirname(le);function j(){process.stdout.write(`
\u2588\u2588\u2588\u2588\u2588\u2588\u2557  \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2557  \u2588\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2557   \u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255D\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255D\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255D\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2557 \u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u2550\u2550\u255D
\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2588\u2588\u2557  \u2588\u2588\u2588\u2588\u2588\u2557  \u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2554\u2588\u2588\u2588\u2588\u2554\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2557  
\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u255A\u2550\u2550\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255D  \u2588\u2588\u2554\u2550\u2550\u255D  \u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2557\u2588\u2588\u2554\u2550\u2550\u2588\u2588\u2551\u2588\u2588\u2551\u255A\u2588\u2588\u2554\u255D\u2588\u2588\u2551\u2588\u2588\u2554\u2550\u2550\u255D  
\u2588\u2588\u2588\u2588\u2588\u2588\u2554\u255D\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557\u2588\u2588\u2551     \u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551  \u2588\u2588\u2551\u2588\u2588\u2551 \u255A\u2550\u255D \u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2557
\u255A\u2550\u2550\u2550\u2550\u2550\u255D \u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u255D\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D  \u255A\u2550\u255D\u255A\u2550\u255D     \u255A\u2550\u255D\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u255D

`)}function ue(e){let t=[];function r(n){let o=h.readdirSync(n);for(let i of o){let a=T.join(n,i),s=h.statSync(a);s.isDirectory()?r(a):s.isFile()&&/\.ya?ml$/.test(i)&&t.push(a)}}return r(e),t}function M(){let e=ue(ce),t=[],r=null;for(let n of e)try{let o=h.readFileSync(n,"utf-8"),i=ie.parse(o);i.kind==="Tokens"?t.push(i):i.kind==="TokenCollections"&&(r=i)}catch(o){console.warn(` \u274E failed to parse ${n}:`,o)}return r||(console.error(" \u274E collections.yaml not found"),process.exit(1)),{tokens:t,collections:r}}function de(e,t){let{tokens:r,collections:n}=M(),o=C.generateCssVariables(r,n,{prefix:t,banner:"",selectors:{global:{default:":root"}}});h.ensureDirSync(e);let i=T.join(e,"token.css");h.writeFileSync(i,o,"utf-8"),console.log(` \u2705 Generated CSS variables: ${i}`)}function fe(e,t){let{tokens:r,collections:n}=M(),o=I.generateTailwindCSS(r,n,{prefix:t,banner:""});h.ensureDirSync(e);let i=T.join(e,"tailwind4.css");h.writeFileSync(i,o,"utf-8"),console.log(` \u2705 Generated TailwindCSS 4.0 configuration: ${i}`)}se(process.argv.slice(2)).command("css-vars [dir] [prefix]","Generate CSS variables",e=>e.positional("dir",{describe:"Output directory",type:"string",default:"./dist/"}).option("prefix",{describe:"CSS variable prefix",type:"string"}),e=>{j(),de(e.dir,e.prefix)}).command("tailwindcss [dir] [prefix]","Generate TailwindCSS 4.0 configuration",e=>e.positional("dir",{describe:"Output directory",type:"string",default:"./dist/"}).option("prefix",{describe:"CSS variable prefix",type:"string"}),e=>{j(),fe(e.dir,e.prefix)}).demandCommand(1,"You need to specify a command.").showHelpOnFail(!0).help().argv;
